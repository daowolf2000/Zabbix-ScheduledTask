zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 80400c8bc6ec477b932244f6e1084380
      name: Template/VLDK
  templates:
    - uuid: 57954842d3fb43c5923be6da6458432f
      template: 'VLDK - Windows - Task Scheduled'
      name: 'VLDK - Windows - Task Scheduled'
      description: 'Discover and monitor Task Scheduler Library tasks via PowerShell.'
      groups:
        - name: Template/VLDK
      discovery_rules:
        - uuid: 2c727e6fbe3f4f26903bd376636f19aa
          name: 'Task Scheduler'
          type: ZABBIX_ACTIVE
          key: 'TaskSchedulerMonitoring[discovertasks]'
          delay: '{$TIME.DISCOVERY.UPDATE:"TASK"}'
          filter:
            conditions:
              - macro: '{#APPTASKS}'
                value: '^(?!.*(?:OneDrive|WindowsUpdate|Microsoft\.|MicrosoftEdgeUpdateTask|GoogleUpdate|CompatibilityAssistant|AdobeARM|Defender)).*$'
                formulaid: A
          lifetime_type: DELETE_IMMEDIATELY
          lifetime: '0'
          description: 'Discover tasks in Task Scheduler Library.'
          item_prototypes:
            - uuid: 68b168b5266c4f66864a99065c2549c3
              name: 'Task: {#APPTASKS}: Last Result'
              type: ZABBIX_ACTIVE
              key: 'TaskSchedulerMonitoring[TaskLastResult,{#APPTASKS}]'
              delay: '120'
              history: 90d
              description: 'Last result code of the task.'
              valuemap:
                name: 'Task Scheduled'
              tags:
                - tag: Application
                  value: 'Task Scheduled'
              trigger_prototypes:
                - uuid: 38319f71a98644c2adec75c48463d4c1
                  expression: 'last(/VLDK - Windows - Task Scheduled/TaskSchedulerMonitoring[TaskLastResult,{#APPTASKS}])<>0 and last(/VLDK - Windows - Task Scheduled/TaskSchedulerMonitoring[TaskLastResult,{#APPTASKS}])<>267008 and last(/VLDK - Windows - Task Scheduled/TaskSchedulerMonitoring[TaskLastResult,{#APPTASKS}])<>267009 and last(/VLDK - Windows - Task Scheduled/TaskSchedulerMonitoring[TaskLastResult,{#APPTASKS}])<>267011 and last(/VLDK - Windows - Task Scheduled/TaskSchedulerMonitoring[TaskLastResult,{#APPTASKS}])<>267014'
                  name: 'Tasks: Ошибка при запуске запланированной задачи {#APPTASKS}'
                  opdata: '{ITEM.LASTVALUE1}'
                  priority: WARNING
                  manual_close: 'YES'
            - uuid: ee287193334d4630a3fb0eceaa924711
              name: 'Task: {#APPTASKS}: Last Run Time'
              type: ZABBIX_ACTIVE
              key: 'TaskSchedulerMonitoring[TaskLastRunTime,{#APPTASKS}]'
              delay: '120'
              history: 90d
              units: unixtime
              description: 'Unix timestamp of last run.'
              tags:
                - tag: Application
                  value: 'Task Scheduled'
            - uuid: 4cb82427c9684d27aada5a12b6ea3cae
              name: 'Task: {#APPTASKS}: Next Run Time'
              type: ZABBIX_ACTIVE
              key: 'TaskSchedulerMonitoring[TaskNextRunTime,{#APPTASKS}]'
              delay: '120'
              history: 90d
              units: unixtime
              description: 'Unix timestamp of next run.'
              tags:
                - tag: Application
                  value: 'Task Scheduled'
      valuemaps:
        - uuid: 839b33549ce54b11927857ff95597d20
          name: 'Task Scheduled'
          mappings:
            - value: '0'
              newvalue: Success
            - value: '267008'
              newvalue: Ready
            - value: '267009'
              newvalue: Running
            - value: '267010'
              newvalue: Disabled
            - value: '267011'
              newvalue: 'Not yet run'
            - value: '267012'
              newvalue: 'No more runs'
            - value: '267013'
              newvalue: 'Not scheduled'
            - value: '267014'
              newvalue: 'Terminated by user'
            - value: '267015'
              newvalue: 'No valid triggers'
            - value: '267016'
              newvalue: 'Event triggers only'
            - value: '267019'
              newvalue: 'Some triggers failed'
            - value: '267020'
              newvalue: 'Batch logon problem'
            - value: '267037'
              newvalue: Queued
            - value: '1'
              newvalue: 'Invalid function'
            - value: '2'
              newvalue: 'File not found'
            - value: '10'
              newvalue: 'Bad environment'
            - value: '0x80041309'
              newvalue: 'Trigger not found'
            - value: '0x8004130A'
              newvalue: 'Task not ready'
            - value: '0x8004130B'
              newvalue: 'Task not running'
            - value: '0x8004130C'
              newvalue: 'Service not installed'
            - value: '0x8004130D'
              newvalue: 'Cannot open task'
            - value: '0x8004130E'
              newvalue: 'Invalid task'
            - value: '0x8004130F'
              newvalue: 'Account info missing'
            - value: '0x80041310'
              newvalue: 'Account not found'
            - value: '0x80041311'
              newvalue: 'Security DB corrupt'
            - value: '0x80041312'
              newvalue: 'No security services'
            - value: '0x80041313'
              newvalue: 'Unknown version'
            - value: '0x80041314'
              newvalue: 'Unsupported account option'
            - value: '0x80041315'
              newvalue: 'Service not running'
            - value: '0x80041316'
              newvalue: 'Unexpected XML node'
            - value: '0x80041317'
              newvalue: 'Unexpected XML namespace'
            - value: '0x80041318'
              newvalue: 'Invalid XML value'
            - value: '0x80041319'
              newvalue: 'Missing XML node'
            - value: '0x8004131A'
              newvalue: 'Malformed XML'
            - value: '0x8004131B'
              newvalue: 'Too many XML nodes'
            - value: '0x8004131C'
              newvalue: 'Past end boundary'
            - value: '0x8004131F'
              newvalue: 'Already running'
            - value: '0x80041320'
              newvalue: 'User not logged on'
            - value: '0x80041321'
              newvalue: 'Invalid task hash'
            - value: '0x80041322'
              newvalue: 'Service unavailable'
            - value: '0x80041323'
              newvalue: 'Service too busy'
            - value: '0x80041324'
              newvalue: 'Task attempt failed'
            - value: '0x80041326'
              newvalue: 'Task disabled'
            - value: '0x80041327'
              newvalue: 'Not v1 compatible'
            - value: '0x80041328'
              newvalue: 'Cannot start on demand'
            - value: '0x80041329'
              newvalue: 'Not UBPM compatible'
            - value: '0x80041330'
              newvalue: 'Deprecated feature used'
            - value: '-2147024894'
              newvalue: 'Sys: File not found'
            - value: '-2147024635'
              newvalue: 'Sys: Path not found'
            - value: '-2147024675'
              newvalue: 'Sys: Service missing'
            - value: '-1073741510'
              newvalue: 'App: CTRL+C exit'
            - value: '-1073479810'
              newvalue: 'App: Fatal exception'
            - value: '-1073741502'
              newvalue: 'App: Init failed'
            - value: '2147942402'
              newvalue: 'File not found'
